
<!DOCTYPE HTML>

<html>

<head>
	<meta charset="utf-8">
	<title>hSATAC</title>
	<meta name="author" content="Ash Wu">

	
	<meta name="description" content="Feb 21st, 2013 Archlinux, puppet Comments ArchLinux 使用 Puppet 注意事項 想在 ArchLinux 使用 Puppet 有一些需要注意的地方，在這邊順便補充一下。 systemctl 路徑 Arch 在之前的改版已經把 /bin/ &hellip;">
	

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

	<link href="http://feeds.feedburner.com/hsatac" rel="alternate" title="hSATAC" type="application/atom+xml">
	
	<link rel="canonical" href="http://blog.hsatac.net/page/3/">
	<link href="/favicon.png" rel="shortcut icon">
	<link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
	<!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->
	<link href='http://fonts.googleapis.com/css?family=Open+Sans:400italic,400,700' rel='stylesheet' type='text/css'>
	<!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<!-- Add jQuery library -->
<script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
<script type="text/javascript" src="/javascripts/jquery.fancybox.pack.js?v=2.0.4"></script>
<script type="text/javascript">
  $(document).ready(function() {
      $("a[href$='.jpg'],a[href$='.png'],a[href$='.gif']").fancybox();
  });
</script>

</head>


<body>
	<div class="container">
		<div class="left-col">
			<div class="intrude-less">
			<header id="header" class="inner"><div class="profilepic">
	<script src="/javascripts/md5.js"></script>
	<script type="text/javascript">
		$(function(){
			$('.profilepic').append("<img src='http://www.gravatar.com/avatar/" + MD5("hsatac@gmail.com") + "?s=160' alt='Profile Picture' style='width: 160px;' />");
		});
	</script>
</div>
<hgroup>
  <h1><a href="/">hSATAC</a></h1>
  
</hgroup>

<nav id="main-nav"><ul class="main-navigation">
  <li><a href="/">Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
  <li><a href="http://blog.ash.cat">Hobbies</a></li>
</ul>


<section class="aboutme">
  <p>
    I am a programming language user. Here are some breadcrumbs of my work and life.
 >> ('cat' + 'ash').reverse #=> "hsatac"
  </p>
</section>
</nav>
<nav id="sub-nav">
	<div class="social">
		
		<a class="facebook" href="http://www.facebook.com/hSATAC" title="Facebook">Facebook</a>
		
		
		<a class="google" href="https://plus.google.com/113141223333997550446" rel="author" title="Google+">Google+</a>
		
		
		<a class="twitter" href="http://twitter.com/hSATAC" title="Twitter">Twitter</a>
		
		
		<a class="github" href="https://github.com/hSATAC" title="GitHub">GitHub</a>
		
		
		
		
		<a class="linkedin" href="http://www.linkedin.com/in/hSATAC" title="LinkedIn">LinkedIn</a>
		
		
		
		<a class="delicious" href="http://delicious.com/cat" title="Delicious">Delicious</a>
		
		
		
		<a class="rss" href="http://feeds.feedburner.com/hsatac" title="RSS">RSS</a>
		
	</div>
</nav>
</header>				
			</div>
		</div>	
		<div class="mid-col">
			
				
			
			<div class="mid-col-container">
				<div id="content" class="inner">
<div itemscope itemtype="http://schema.org/Blog">


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="meta">
        <div class="date">








  


<time datetime="2013-02-21T14:12:00+08:00" data-updated="true" itemprop="datePublished">Feb 21<span>st</span>, 2013</time></div>
        <div class="tags">


	<a class='category' href='/categories/archlinux/'>Archlinux</a>, <a class='category' href='/categories/puppet/'>puppet</a>


</div>
        
        <span class="comments"><a href="/2013/02/using-puppet-on-archlinux/#disqus_thread">Comments</a></span>
        
    </div>
	<h1 class="title" itemprop="name"><a href="/2013/02/using-puppet-on-archlinux/" itemprop="url">ArchLinux 使用 Puppet 注意事項</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>想在 ArchLinux 使用 Puppet 有一些需要注意的地方，在這邊順便補充一下。</p>

<h2>systemctl 路徑</h2>

<p>Arch 在之前的改版已經把 <code>/bin/systemctl</code> 移到 <code>/usr/bin/systemctl</code> 下，但 Puppet 還是抓 <code>/usr/systemctl</code> 導致找不到 systemd 這個 provider ，這個問題已經在 Puppet 3.1 修改，也可以自己手動 link 一下。</p>

<h2>套件庫需更新到最新版</h2>

<p>Arch 每次都要先 <code>pacman -Syy</code> 一下不然 package 會無法使用。</p>

<p>以上這兩個問題我有寫了一段 module</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
<span class='line-number'>10</span>
<span class='line-number'>11</span>
</pre></td><td class='code'><pre><code class=''><span class='line'># For Archlinux. This issue will be fixed in puppet 3.1
</span><span class='line'>
</span><span class='line'>class archfix {
</span><span class='line'>    file {'/bin/systemctl':
</span><span class='line'>        ensure => link,
</span><span class='line'>        target => '/usr/bin/systemctl',
</span><span class='line'>    }   
</span><span class='line'>    exec {'pacman -Syy':
</span><span class='line'>        path => ["/usr/bin"]
</span><span class='line'>    }   
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<p>在 manifest 中利用 stage 功能先執行 archfix 這個 module 就可以了。</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
<span class='line-number'>8</span>
<span class='line-number'>9</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>node 'devm3' {
</span><span class='line'>    stage { 'pre': }
</span><span class='line'>    class {
</span><span class='line'>        "archfix": stage => "pre"; 
</span><span class='line'>    }   
</span><span class='line'>    Stage["pre"] -> Stage["main"]
</span><span class='line'>
</span><span class='line'>  # include other modules...
</span><span class='line'>}</span></code></pre></td></tr></table></div></figure>


<h2>Openrc &amp; Systemd</h2>

<p>ArchLinux 現在還有很多套件同時支援 openrc 的 initscript 和 systemd，Puppet 會偵測到兩個 provider 但是他會選擇用 initscript 。可以在 service resource 指定 <code>provider =&gt; systemd</code> 即可。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="meta">
        <div class="date">








  


<time datetime="2013-02-19T17:51:00+08:00" data-updated="true" itemprop="datePublished">Feb 19<span>th</span>, 2013</time></div>
        <div class="tags">


	<a class='category' href='/categories/archlinux/'>Archlinux</a>, <a class='category' href='/categories/puppet/'>puppet</a>


</div>
        
        <span class="comments"><a href="/2013/02/bootstrap-archlinux-with-puppet/#disqus_thread">Comments</a></span>
        
    </div>
	<h1 class="title" itemprop="name"><a href="/2013/02/bootstrap-archlinux-with-puppet/" itemprop="url">使用 Puppet 快速佈署 Archlinux</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>筆記一下安裝步驟&hellip;。</p>

<h2>Install Archlinux</h2>

<p>由於 Archlinux 本身沒有提供方便的安裝模式、因此我們使用 <a href="https://twitter.com/helmuthdu">@helmuthdu</a> 的快速安裝 script <a href="https://github.com/helmuthdu/aui">AUI</a>，安裝完成後再使用 puppet bootstrap 環境</p>

<ul>
<li>放入 CD 選擇 x64_64 開機</li>
<li>執行 <code>curl hsatac.net/getaui | sh</code></li>
<li>進入 helmuthdu-aui-xxxx 目錄</li>
<li>執行 <code>./aui --ais</code> 進入安裝程式</li>
<li>輸入 1-14 執行全部安裝步驟</li>
</ul>


<p>ps. 如遇特定機種無法使用 grub2 可改用 syslinux bootloader</p>

<h2>Reboot</h2>

<p>安裝完成重開機後後首先設定讓網路能通
可參考<a href="https://wiki.archlinux.org/index.php/Network_Configuration">官方wiki</a></p>

<p>如欲使用 dhcp 可執行 <code>systemctl start dhcpcd</code>
<code>systemctl enable dhcpcd</code> 開機自動執行</p>

<ul>
<li>回到 helmuthdu-aui-xxx 目錄</li>
<li>執行 <code>./aui</code> 繼續安裝</li>
<li>新增使用者步驟必須執行，因後續步驟需用 sudo</li>
<li>AUR helper 選擇 yaourt
(Yaourt 和 packer 大同小異，但因 puppet 使用 yaourt 所以改用。)</li>
<li>後面的 setup 可跳過，或者裝 Basic Setup 即可，這邊都是 桌面環境相關</li>
<li>設定 /etc/resolv.conf</li>
</ul>


<h2>使用 puppet</h2>

<p>puppet 可使用 master-agent 架構或者單機(solo) 安裝，詳見 puppet wiki</p>

<ul>
<li><code>yaourt puppet</code> 安裝 puppet</li>
<li>在 /etc/hosts 設定 puppet master hostname 並在 /etc/puppet/puppet.conf [agent] 區塊設定 <code>server = xxx</code> (hostname 要跟 master hostname 一樣不然憑證不會過)</li>
<li>run <code>puppet agent --test</code> 會出現沒有憑證訊息</li>
<li>回到 puppet master 執行 <code>puppet cert list</code> 會看到待簽署的憑證</li>
<li>執行 <code>puppet cert sign [hostname]</code> 簽署</li>
<li>記得在 master 的 /etc/puppet/manifests/site.pp 設定新的 node 定義</li>
<li>回到 agent 執行 <code>puppet agent --test</code> 進行安裝</li>
</ul>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="meta">
        <div class="date">








  


<time datetime="2013-02-15T17:54:00+08:00" data-updated="true" itemprop="datePublished">Feb 15<span>th</span>, 2013</time></div>
        <div class="tags">


	<a class='category' href='/categories/rwby/'>RWBY</a>


</div>
        
        <span class="comments"><a href="/2013/02/rwby/#disqus_thread">Comments</a></span>
        
    </div>
	<h1 class="title" itemprop="name"><a href="/2013/02/rwby/" itemprop="url">RWBY</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>RWBY 第二部預告片 &ldquo;White&rdquo; 終於推出！</p>

<p>之前看完第一部 &ldquo;Red&rdquo; 時還沒有特別被萌到，只覺得創意、畫面和音樂都還不錯。不過這次看完 &ldquo;White&rdquo; 以後整個點都被打到啦！直接去 itunes 收了這兩首 OST…</p>

<p>下一部 &ldquo;Black&rdquo; 預計在 2013.07 發佈，這樣算來本體推出都要 2014 啦！實在是很大一個坑&hellip;</p>

<iframe width="560" height="315" src="http://www.youtube.com/embed/Vt9vl8iAN5Q" frameborder="0" allowfullscreen></iframe>



		
		<a href="/2013/02/rwby/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="meta">
        <div class="date">








  


<time datetime="2013-01-30T10:18:00+08:00" data-updated="true" itemprop="datePublished">Jan 30<span>th</span>, 2013</time></div>
        <div class="tags">


	<a class='category' href='/categories/ruby/'>Ruby</a>


</div>
        
        <span class="comments"><a href="/2013/01/trace-rubygems-require-slow/#disqus_thread">Comments</a></span>
        
    </div>
	<h1 class="title" itemprop="name"><a href="/2013/01/trace-rubygems-require-slow/" itemprop="url">追蹤 Rubygems Require 緩慢紀錄</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>昨天灌了一台新的機器，正準備用 <a href="http://puppetlabs.com">puppet</a> bootstrap 時卻發現他的 puppet 執行的非常緩慢。追蹤解決問題的過程十分有趣，在這邊紀錄一下。</p>

<p>由於 puppet 執行檔本身是一隻 ruby script，於是開啟了 irb -d 使用 DEBUG 模式直接執行看看該 script 的內容，看看能否看出問題在哪。</p>


		
		<a href="/2013/01/trace-rubygems-require-slow/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="meta">
        <div class="date">








  


<time datetime="2012-12-09T13:04:00+08:00" data-updated="true" itemprop="datePublished">Dec 9<span>th</span>, 2012</time></div>
        <div class="tags">


	<a class='category' href='/categories/ruby/'>Ruby</a>, <a class='category' href='/categories/rubyconf/'>Rubyconf</a>


</div>
        
        <span class="comments"><a href="/2012/12/ruby-conf-taiwan-2012-en/#disqus_thread">Comments</a></span>
        
    </div>
	<h1 class="title" itemprop="name"><a href="/2012/12/ruby-conf-taiwan-2012-en/" itemprop="url">RubyConf.tw 2012</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>Ruby Conf Taiwan 2012 is so amazing I have to write it down.</p>

<h3>Before Party</h3>

<p><a href="http://twitter.com/ihower">ihower</a> had been inviting Matz, the creator of Ruby to Taiwan for the past three years. And finally he made it this year. Matz arrived Taiwan early, since it was a great opportunity to meet Matz in person so we hosted a meetup party with Matz the day before the conference.</p>

<p><img src="/images/rubyconftw2012/matz_and_i.jpg" alt="matz and I" /></p>


		
		<a href="/2012/12/ruby-conf-taiwan-2012-en/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="meta">
        <div class="date">








  


<time datetime="2012-12-09T13:04:00+08:00" data-updated="true" itemprop="datePublished">Dec 9<span>th</span>, 2012</time></div>
        <div class="tags">


	<a class='category' href='/categories/ruby/'>Ruby</a>, <a class='category' href='/categories/rubyconf/'>Rubyconf</a>


</div>
        
        <span class="comments"><a href="/2012/12/ruby-conf-taiwan-2012/#disqus_thread">Comments</a></span>
        
    </div>
	<h1 class="title" itemprop="name"><a href="/2012/12/ruby-conf-taiwan-2012/" itemprop="url">RubyConf.tw 2012 流水帳</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>今年的 Ruby Conf Taiwan 2012 實在太精彩，太感動了，一定要寫下來紀錄一下。</p>

<h3>前夜祭</h3>

<p>首先是經過 ihower 三年的邀請，今年終於邀請到 Ruby 之父 Matz 來到台灣。由於 Matz 提早到台灣，所以在 Ruby Conf 的前一天晚上也臨時加開了 Matz 見面會，能有這個近距離和大師接觸，聊天，提問的機會實在非常難得。不過也許是這時候大家把問題都問的差不多了，結果隔天 Matz 的 keynote 反而沒什麼人提問(笑)。</p>

<p><img src="/images/rubyconftw2012/matz_and_i.jpg" alt="matz and I" /></p>


		
		<a href="/2012/12/ruby-conf-taiwan-2012/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="meta">
        <div class="date">








  


<time datetime="2012-11-26T15:15:00+08:00" data-updated="true" itemprop="datePublished">Nov 26<span>th</span>, 2012</time></div>
        <div class="tags">


	<a class='category' href='/categories/mac/'>Mac</a>


</div>
        
        <span class="comments"><a href="/2012/11/macbook-pro-2010-mid-replace-optical-drive-with-ssd-and-fusion-drive/#disqus_thread">Comments</a></span>
        
    </div>
	<h1 class="title" itemprop="name"><a href="/2012/11/macbook-pro-2010-mid-replace-optical-drive-with-ssd-and-fusion-drive/" itemprop="url">2010 MBP 升級 SSD 與 Fusion Drive</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>我現在用來開發 iOS 的電腦是公司提供的一台 Macbook Pro 13&#8221; 2010 mid 4G ram。使用上還算堪用，但時不時的 lag 以及 freeze 實在非常挑戰開發者的耐心。尤其當我 Xcode 開著，git 切換 branch 然後 Xcode 重新 index 的時候簡直慘不忍睹。</p>

<p>畢竟電腦還是自己在用，開心順手最重要，所以決定自己投資一點下去升級。因為光碟機很少在用，所以查了一下以前看過的硬碟轉接托架，意外發現非常便宜才 200 多元，還附拆機工具組。參考<a href="http://blog.lyhdev.com/2012/10/apple-macbook-pro-ssd.html">玩物喪誌</a>的心得一樣購買 Jeyi 的硬碟托架以及 Micron M4 7mm 超薄 SSD。別人踩過一次的雷就不用再踩了。</p>

<p>把光碟機拆下，原本的位置裝上 SSD。內裝的硬碟則不動。如果把內裝硬碟裝在硬碟托架的話硬碟的感震偵測會無法作用。拆機安裝部分參考 <a href="http://www.ifixit.com/Guide/MacBook+Pro+13-Inch+Unibody+Mid+2010+Optical+Drive+Replacement/4318/">ifixit</a> 的說明。最需要注意的是螺絲不要滑牙了。</p>

<p>在拆機的過程中也順便把家裡的 Mac mini server 8G 出包版的記憶體拆下與 MBP 的 4G 對調，兩組都是 DDR 3 1066 的規格，對換毫無困難。</p>

<p>裝上以後開機確認是否有抓到及辨識到 SSD 固態硬碟，link speed 也跑到 SATA II 全速。接著使用 Carbon Copy Cloner 先把原本的系統碟備份到外接 USB 硬碟。再改用 USB 硬碟開機，準備做 Fusion Drive。</p>

<p>會使用 Fusion Drive 的原因是 SSD 實在不夠大，原本要自己安排哪些目錄放 SSD，哪些少用放 HD ，但是使用 Fusion Drive 技術的話可以將 SSD 與 HD 變成一顆邏輯磁碟，而系統會自己幫你判斷哪些常用的檔案放在 SSD, 不常用的則移去 HD ，兼顧了速度與容量和便利性，似乎是個不錯的選擇，所以決定試試看。</p>

<p>參考 <a href="http://jollyjinx.tumblr.com/post/34638496292/fusion-drive-on-older-macs-yes-since-apple-has">Fusion drive on older Macs? YES!</a> 的說明做好 Fusion Drive，再用 Carbon Copy Cloner 把外接 USB 硬碟的資料複製回做好的 Fusion Drive。值得一提的是 Fusion Drive 似乎無法製作 Recovery Partition，這部份只好無視他的 warning 。</p>

<p>最後把 Fusion Drive 設為開機碟重開就完成了這次的升級。相關照片和紀錄都放在 <a href="http://www.facebook.com/media/set/?set=a.4857081506317.2196205.1275503618&amp;type=1&amp;l=bb8d23d675">Facebook 相簿</a> 中。</p>

		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="meta">
        <div class="date">








  


<time datetime="2012-11-13T11:53:00+08:00" data-updated="true" itemprop="datePublished">Nov 13<span>th</span>, 2012</time></div>
        <div class="tags">


	<a class='category' href='/categories/sentry/'>Sentry</a>


</div>
        
        <span class="comments"><a href="/2012/11/sentry-introduction-slides/#disqus_thread">Comments</a></span>
        
    </div>
	<h1 class="title" itemprop="name"><a href="/2012/11/sentry-introduction-slides/" itemprop="url">Sentry 簡介投影片</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<script async class="speakerdeck-embed" data-id="509a1faa3a7976000202bd2c" data-ratio="1.2994923857868" src="//speakerdeck.com/assets/embed.js"></script>


		
		
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="meta">
        <div class="date">








  


<time datetime="2012-11-06T13:17:00+08:00" data-updated="true" itemprop="datePublished">Nov 6<span>th</span>, 2012</time></div>
        <div class="tags">


	<a class='category' href='/categories/php/'>PHP</a>


</div>
        
        <span class="comments"><a href="/2012/11/php-array-plus-array-versus-array-merge/#disqus_thread">Comments</a></span>
        
    </div>
	<h1 class="title" itemprop="name"><a href="/2012/11/php-array-plus-array-versus-array-merge/" itemprop="url">PHP Array 相加與 Array_merge</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>今天聊到這個問題，喚起我沈睡的記憶…應該寫下來不然兩年後我大概又會忘了。</p>

<p>在 PHP 中 <code>array + array</code> 與 <code>array_merge</code> 的行為是不一樣的，陣列相加的效能會比 <code>array_merge</code> 來的好，但換來的代價是可能不是你預期的行為以及資料流失。</p>

<p>PHP 的陣列可以有 key 也可以沒有 key，也可以兩者混合。不過所謂的沒有 key ，其實他還是有 key ，只是是自動編上去的 int 流水號 key 例如 0,1,2,3&hellip;不管是哪一種，在陣列相加以及 <code>array_merge</code> 的行為都不一樣。</p>

<p>先講一下 <code>array_merge</code> 的行為，<code>array_merge($a, $b)</code> 的話，如果 <code>$a</code> 和 <code>$b</code> 裡面有 key 相同的元素，則會<strong>後蓋前</strong>也就是 <code>$b</code> 的值會蓋掉 <code>$a</code> 的值。那如果是沒有 key (流水號 key)的值，則會以附加在尾端 (append) 的方式合併上去，而所有流水號 key 的 index 則會重排。</p>


		
		<a href="/2012/11/php-array-plus-array-versus-array-merge/" class="more-link">Read on &rarr;</a>
	</div>

</article>


    <article class="post" itemprop="blogPost" itemscope itemtype="http://schema.org/BlogPosting">
    <div class="meta">
        <div class="date">








  


<time datetime="2012-10-30T13:14:00+08:00" data-updated="true" itemprop="datePublished">Oct 30<span>th</span>, 2012</time></div>
        <div class="tags">


	<a class='category' href='/categories/ios/'>iOS</a>, <a class='category' href='/categories/unit-test/'>unit test</a>


</div>
        
        <span class="comments"><a href="/2012/10/obj-c-unit-test-with-asynchronous-request/#disqus_thread">Comments</a></span>
        
    </div>
	<h1 class="title" itemprop="name"><a href="/2012/10/obj-c-unit-test-with-asynchronous-request/" itemprop="url">Obj-C 單元測試非同步連線</a></h1>
	<div class="entry-content" itemprop="articleBody">
		<p>使用 Xcode 的 OCUnit 來做單元測試網路連線時，由於 OCUnit 不會等 block 執行，所以會直接跳到 pass。一般正常作法應該是用 mock object 來測試，不過總有要實際測試真實連線的時候。這時可以使用以下的 snippet:</p>

<div><script src='https://gist.github.com/3978482.js'></script>
<noscript><pre><code>- (void)testLogin
{
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
    [[miiiCasaServer getServer] login:@&quot;test@example.com&quot; andPassword:@&quot;password&quot; success:^(AFHTTPRequestOperation *operation, id responseObject) {
        assertThat(responseObject[@&quot;status&quot;], is(@&quot;ok&quot;));
        dispatch_semaphore_signal(semaphore);
    } failure:nil];
    while (dispatch_semaphore_wait(semaphore, DISPATCH_TIME_NOW))
        [[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode
                                 beforeDate:[NSDate dateWithTimeIntervalSinceNow:10]];
    dispatch_release(semaphore);   // You don&#39;t need this if your deployment target &gt;= 6.0 and ARC enabled.
}
- (void)testLoginFail
{
    dispatch_semaphore_t semaphore = dispatch_semaphore_create(0);
    [[miiiCasaServer getServer] login:@&quot;test@example.com&quot; andPassword:@&quot;wrongpassword&quot; success:nil failure:^(AFHTTPRequestOperation *operation, NSError *error) {
        assertThat([[error userInfo] objectForKey:@&quot;errmsg&quot;], containsString(@&quot;incorrect&quot;));
        assertThatInteger([error code], equalToInt(401));
        dispatch_semaphore_signal(semaphore);
    }];
    while (dispatch_semaphore_wait(semaphore, DISPATCH_TIME_NOW))
        [[NSRunLoop currentRunLoop] runMode:NSDefaultRunLoopMode
                                 beforeDate:[NSDate dateWithTimeIntervalSinceNow:10]];
    dispatch_release(semaphore);   // You don&#39;t need this if your deployment target &gt;= 6.0 and ARC enabled.
}</code></pre></noscript></div>




		
		
	</div>

</article>

</div>
<nav id="pagenavi">
    
        <a href="/page/2/" class="prev">Prev</a>
    
    
        <a href="/page/4/" class="next">Next</a>
    
    <div class="center"><a href="/blog/archives">Blog Archives</a></div>
</nav></div>
			</div>
			<footer id="footer" class="inner"><p>
  Copyright &copy; 2014 - Ash Wu -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span> - Logo authorized by <a href="http://www3.ocn.ne.jp/~musimaru/">64CAT64</a>
</p>

Design credit: <a href="http://shashankmehta.in/archive/2012/greyshade.html">Shashank Mehta</a></footer>
			<script src="/javascripts/slash.js"></script>


<script type="text/javascript">
      var disqus_shortname = 'hsatac';
      
        
        var disqus_script = 'count.js';
      
    (function () {
      var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
      dsq.src = 'http://' + disqus_shortname + '.disqus.com/' + disqus_script;
      (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    }());
</script>



	<script type="text/javascript">
		var _gaq = _gaq || [];
		_gaq.push(['_setAccount', 'UA-27441833-1']);
		_gaq.push(['_trackPageview']);

		(function() {
			var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
			ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
			var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
		})();
	</script>





		</div>
	</div>
</body>
</html>
